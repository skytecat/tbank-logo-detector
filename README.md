- Добавить ссылки на данные
- Подробную инструкцию добавить
- Добавить результаты модели

# Детекция логотипа Т-Банка
## Оглавление

- [Описание задачи](#описание-задачи)
- [Подход к решению](#подход-к-решению)
- [Инструкция по запуску](#инструкция-по-запуску)
- [Контракт API](#контракт-api)
- [Метрики качества](#метрики-качества)
- [Валидационный набор](#валидационный-набор)
- [Ссылки на ресурсы](#ссылки-на-ресурсы)
- [Анализ и предложения по улучшению](#анализ-и-предложения-по-улучшению)

---

## Описание задачи

Цель - создать REST API сервис, который детектирует логотип Т-Банка (стилизованная буква "Т" в щите) на загружаемых изображениях и возвращает координаты bounding box'ов.  
Логотипы "Тинькофф" должны игнорироваться.  
Решение должно быть упаковано в Docker, запускаться на порту 8000 и соответствовать Pydantic-спецификации

---

## Подход к решению

### 1. Подготовка данных
#### 1. Загрузка датасета
Из исходного датасета было выбрано 3000 изображений, которые были разделены на папки по 200 изображений (part_1, part_2, ...) - для удобства обработки

#### 2. Автоматический отбор изображений с потенциальными логотипами (zero-shot подход)
Для подготовки данных использован zero-shot подход, не требующий предварительной разметки:

Template Matching (OpenCV)
Метод: cv2.matchTemplate с методом TM_CCOEFF_NORMED - поиск похожих областей на изображении.
Шаблоны: Использовано 6 шаблонов логотипа Т-Банка (разных размеров, цветов и углу поворота) для повышения охвата.
Адаптация: Если шаблон больше изображения - он автоматически уменьшается пропорционально.
Порог совпадения: MATCH_THRESHOLD = 0.65 - баланс между точностью и полнотой.

Скрипт проходит по всем частям, применяет Template Matching, и копирует подходящие изображения в специальную папку.
В результате отобрано более **300** изображений с высокой вероятностью наличия логотипа Т-Банка

#### 3. Ручная разметка bounding box’ов
На основе автоматически отобранных изображений была проведена качественная ручная разметка с использованием интерактивного инструмента на базе ipywidgets. Подход позволил гибко корректировать результаты автоматического отбора и обеспечивать высокую точность аннотаций

**Категории изображений при разметке:**
- Корректно размеченные автоматически - на некоторых изображениях рамка, предложенная Template Matching, полностью соответствовала реальному положению логотипа. Такие изображения принимались “как есть” - с сохранением одной (наилучшей) рамки.
- Требующие корректировки - в большинстве случаев автоматическая рамка была близка к истине, но требовала небольшой подгонки (смещение, изменение размера)
- Ошибочно отобранные - некоторые изображения прошли автоматический отбор, но на них логотип отсутствовал. Такие изображения либо пропускались и не попадали в папку с положительными изображениями

**Дополнительно создано 30 положительных примеров**
Для улучшения обобщающей способности модели вручную были созданы и размечены 30 дополнительных положительных изображений - с логотипами в нестандартных условиях (мелкие, под углом, на сложном фоне)

**Формат и результат**
Все аннотации сохранены в формате YOLO: class x_center y_center width height (относительные координаты).
Разметка хранится в папке, где каждый .txt файл соответствует изображению с тем же именем

Итог: получено ~150 качественно размеченных изображений

#### 4. Добавление негативных примеров
Добавлено 30 изображений без логотипа - с пустыми .txt файлами.
Цель: снижение количества ложных срабатываний (false positives)

#### 5. Разделение данных
Датасет разделён на train (80%) и val (20%) с помощью train_test_split с фиксированным random_state=42 для воспроизводимости.
К негативным примерам (изображения без логотипа) применено пропорциональное разделение - чтобы сохранить баланс классов в обеих выборках

### 2. Обучение модели
Для детекции логотипа Т-Банка была выбрана архитектура YOLOv8n (от Ultralytics) - как оптимальный баланс между скоростью, точностью и потреблением ресурсов, особенно актуальный для небольшого датасета (~200 изображений).

**Обучение проводилось с использованием следующих параметров:**
**Эпох: 100**
Достаточно для сходимости на малом датасете, без переобучения

**Размер изображения: 640x640**
Стандартный размер для YOLO, баланс детализации и скорости

**Размер батча: 16**

**Аугментации: Включены**
Ключевой фактор для улучшения обобщения на малом датасете

**Использованные аугментации**
Для повышения устойчивости модели к вариациям в реальных условиях применены следующие аугментации:

- hsv_h=0.015, hsv_s=0.7, hsv_v=0.4 - вариации оттенка, насыщенности и яркости для имитации разного освещения и цветовых условий
- degrees=10.0 - случайные повороты ±10° - для устойчивости к наклонным логотипам
- scale=0.5 - масштабирование от 0.5x до 1.5x - для детекции логотипов разного размера
- mosaic=1.0 - смешивание 4 изображений в одно (учит модель детектировать объекты на сложном фоне и в кластерах)
- fliplr=0.5 - горизонтальное отражение с вероятностью 50%

## Валидация и контроль качества данных

### 1. Data leakage 
В процессе подготовки датасета и оценки модели было обнаружено, что **валидационная выборка содержала изображения, идентичные тем, что присутствовали в обучающей выборке**. Это приводило к **необъективно завышенным метрикам**, поскольку модель просто «узнавала» уже виденные примеры, а не демонстрировала способность к обобщению.

**Как была выявлена проблема**

Для диагностики использовался **сравнительный анализ по хешу содержимого изображений** (SHA-256). Были вычислены хеши всех изображений в папках `train` и `val`, после чего найдены и визуально подтверждены полные дубликаты.

**Как была решена проблема**

Все идентифицированные дубликаты были **удалены из валидационной выборки** вместе с соответствующими `.txt` файлами разметки. После очистки кэш валидации YOLOv8 был принудительно пересоздан (удалением файла `val.cache`), чтобы гарантировать, что модель оценивается на актуальных данных.

**Результат**

После удаления дубликатов метрики **стали более реалистичными**

### Валидационные данные

Валидационный набор состоит из:
- ? положительных изображений
- ? негативных изображений

Ссылка на данные: 
  
### Оценка качества модели

Модель оценивалась на **валидационном наборе**. Использовались следующие параметры:

- `conf=0.3` — порог уверенности для детекции
- `iou=0.5` — порог пересечения для сопоставления предсказаний и ground truth

**Результаты**
???????

**Анализ ошибок**

Для понимания слабых мест модели были визуализированы **лучшие и худшие предсказания**:

Лучшие предсказания (IoU > 0.9):
- Логотипы на контрастном фоне
- Крупные, фронтальные изображения
- Идеальное совпадение рамок

Худшие предсказания (IoU < 0.5):
- Мелкие логотипы (менее 50 пикселей в ширину)
- Логотипы под углом или на сложном фоне
- Частично закрытые объекты

**Рекомендация:** добавить в датасет больше изображений с мелкими/искажёнными логотипами.

**Визуализация результатов**

Для каждого изображения были сгенерированы изображения с наложенными рамками:

- **Зелёные рамки** — ground truth
- **Красные рамки** — предсказания модели
- **Жёлтые линии + IoU** — связь между GT и лучшим предсказанием

Это позволило **визуально подтвердить** корректность метрик

## Инструкция по запуску

---
